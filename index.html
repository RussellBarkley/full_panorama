<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Deep Zoom Viewer — Stitched Image (Zoomify)</title>

  <!-- Local OpenSeadragon + scalebar plugin -->
  <script src="openseadragon/openseadragon.min.js"></script>
  <script src="openseadragon/openseadragon-scalebar.js"></script>

  <style>
    html, body { height: 100%; margin: 0; background: #111; }
    #osd { width: 100%; height: 100%; }
    .hint { position: absolute; left: 12px; top: 10px; color: #ddd; font: 12px/1.2 sans-serif; opacity: .8; }
  </style>
</head>
<body>
  <div id="osd"></div>

  <script>
    // --- Quick config ---
    // Folder containing ImageProperties.xml and TileGroup*/…
    const DEFAULT_ZOOMIFY = 'stitched_full_zoomify/'; // ensure trailing slash

    // Allow URL param override: index.html?z=relative/folder/
    const params  = new URLSearchParams(location.search);
    let tilesUrl  = params.get('z') || DEFAULT_ZOOMIFY;
    if (tilesUrl && !tilesUrl.endsWith('/')) tilesUrl += '/';

    // If your tiles are PNG, set FILE_FORMAT = 'png'
    const FILE_FORMAT = 'jpg';     // 'jpg' or 'png'
    const TILE_SIZE   = 256;       // must match the tiler setting

    // Measured dimensions from your Zoomify export:
    const Z_WIDTH  = 48438;
    const Z_HEIGHT = 48733;

    // Scale: 8.0453 pixels per micrometer (µm) → pixels per meter for scalebar
    const PX_PER_MICRON = 8.0453;
    const PX_PER_METER  = PX_PER_MICRON * 1e6;

    const viewer = OpenSeadragon({
      id: 'osd',
      prefixUrl: 'openseadragon/images/',   // path to OSD button icons
      showNavigator: false,
      animationTime: 0.9,
      blendTime: 0.2,
      springStiffness: 6.5,
      maxZoomPixelRatio: 2.5,
      visibilityRatio: 0.5,
      minZoomLevel: 0,

      // Zoomify tile source
      tileSources: {
        type: 'zoomifytileservice',
        tilesUrl: tilesUrl,        // folder with ImageProperties.xml
        width:  Z_WIDTH,           // avoids extra XML fetch
        height: Z_HEIGHT,
        tileSize: TILE_SIZE,
        fileFormat: FILE_FORMAT    // ensures correct file extension
      }
    });

    // Add a scalebar (MAP mode uses pixelsPerMeter)
    viewer.addHandler('open', () => {
      viewer.scalebar({
        type: OpenSeadragon.ScalebarType.MICROSCOPY,
        pixelsPerMeter: PX_PER_METER,                 // 8.0453 px/µm → 8,045,300 px/m
        location: OpenSeadragon.ScalebarLocation.BOTTOM_LEFT,
        xOffset: 12,
        yOffset: 12,
        barThickness: 4,
        color: 'white',
        fontColor: 'white',
        backgroundColor: 'rgba(0,0,0,0.5)',
        stayInsideImage: true
      });
    });
  </script>
</body>
</html>
